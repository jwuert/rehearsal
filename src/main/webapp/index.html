<!DOCTYPE html>
<html lang="de">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="icon" href="/rehearsal/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" type="text/css" href="sport/css/style.css">
    <link rel="stylesheet" type="text/css" href="sport/css/bootstrap.min.css">
    <meta name="robots" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <script type="text/javascript" src="sport/lib/jquery-3.5.1.slim.min.js"></script>
    <script type="text/javascript" src="sport/lib/popper.min.js"></script>
    <script type="text/javascript" src="sport/lib/bootstrap.min.js"></script>
    <script type="text/javascript" src="sport/js/datamodel.js"></script>
    <script type="text/javascript">

        var rootName = "Schubert";
        var rootId = 1;

        const params = new URLSearchParams(window.location.search);
        const _login = params.get("login");
        const dayName = (date) => date.toLocaleDateString("de-DE", { weekday: "long" }).slice(0, 2);

        var upcomingAppointment = "";
        var _userName = "";
        var _userId = "";
        var _userMap = {};
        var _next_id = -1;
        var _superuser = false;
        var reload = (sessionStorage.getItem("data")==null || sessionStorage.getItem("data")=="null" ? false : true);
        var _actionMap = {};
        var _orig = (reload ? JSON.parse(sessionStorage.getItem("orig")) : null );
        var _data = null;//(reload ? JSON.parse(sessionStorage.getItem("data")) : null );
        var _model = (reload ? JSON.parse(sessionStorage.getItem("model")) : null );
        var _items = {};
	    var _appName = "-";
	    var documentMap = {};

        var ws;
        function initWS() {
            console.log("Running project: " + getProjectId());
            // var wsUri = "ws://" + window.location.hostname + ":" + window.location.port + "/" + getProjectId() + "/socket";
            const wsUri = (window.location.protocol === "https:" ? "wss://" : "ws://") + window.location.hostname + ":" + window.location.port + "/" + getProjectId() + "/socket" + "?login="+_login;

            console.log("connecting to: " + wsUri);
            ws = new WebSocket(wsUri);
            ws.onopen = function() {
                console.log("[WebSocket#onopen]\n");
            }
            ws.onmessage = function(e) {
                jo = JSON.parse(e.data);
                handleMessage(ws, e.data);
            }
            ws.onclose = function(e) {
                console.log("[WebSocket#onclose]\n");
                console.log(e.code, e.reason);
                ws = null;
                document.getElementById("message").innerHTML="Tschöö!";
                document.getElementById("timeline").innerHTML="";
                document.getElementById("downloadSection").innerHTML="";
                setTimeout(function() {
                    document.getElementById("dialog").innerHTML="";
                    document.getElementById("dialog").style.display='none';
                 }, 3000);
            }
            if (ws) {
                setTimeout(function() {
                    for (var id in documentMap) {
                        var name = documentMap[id];
                        if (name==rootName) {
                            rootId = id;
                        }
                    }
                    ws.send("{\"command\":\"openDocument\", \"id\":"+rootId+"}");
                }, 500);
                // $("header").innerHTML="<br/>Speedy";
            }
        }

        function requestElement(parentId, id) {
            if (ws) {
                ws.send("{\"command\":\"requestElement\", \"parentId\":"+parentId+", \"id\":"+id+"}");
            }
        }

        function getProjectId() {
            return window.location.pathname.split("/")[1];
        }

        function getElementByTypeAndId(data, type, id) {
            var loc = null;
            var locList = lookupElement(_data, type);
            for (var i=0; i<locList.length; i++) {
                if (locList[i].attributes["id"]==id) {
                    loc = locList[i];
                    break;
                }
            }
            return loc;
        }

        function showDialog(id, datestrvis) {
            var appointment = getElement(_data, id);
            var aptMsg = appointment.attributes["message"];
            var suppressCancellation = getSuppressCancellation(appointment);
            var aptType = appointment.attributes["type"];
            var typeLabel = _items[aptType];
            var color = "";
            var locId = appointment.attributes["location"];
            var loc = getElementByTypeAndId(_data, "Location", locId);
            var locName = loc.attributes["name"];
            var locAddr = loc.attributes["address"];
            var locPLZ = loc.attributes["plz"];
            var locCity = loc.attributes["city"];
            var html = "<div class='modal-content'>";
		    if (appointment.id == upcomingAppointment.id) {
		        color="orange";
		    } else {
		        color="black";
		    }
		    html += " <div class='modal-header'>";
		    html += "  <h4 class='modal-title' align='center' style='width:100%;color:" + color + "'>" + datestrvis + "</h4>";
		    html += " </div>";
		    html += " <div class='modal-body '>";
            html += " <div class=\"info\">" + typeLabel + "</div>";

            html += "<table>";
            html += "<tr><td>Datum&nbsp;&nbsp;</td><td>" + datestrvis + "</td></tr>";
            html += "<tr><td>Uhrzeit&nbsp;&nbsp;</td><td>" + appointment.attributes["time"] + "</td></tr>";
            html += "<tr><td>Ort </td><td>" + locName + "</td></tr>";
            html += "<tr><td></td><td>" + locAddr + "<br/>" + locPLZ + " " + locCity + "</td></tr>";
            html += "</table>";
            var cancelledUsers = getCancelledUsers(appointment);
            var acceptedUsers = getAcceptedUsers(appointment);
            var numberOfCancelledUsers = cancelledUsers==="" ? 0 : cancelledUsers.split(",").length;
            var numberOfAcceptedUsers = acceptedUsers==="" ? 0 : acceptedUsers.split(",").length;

            if (appointment.attributes.allowAcceptance == "true") {
                html += "<hr/>";
                if (acceptedUsers == "") {
                    html += "Keine Zusagen!";
                } else {
                    html += (_superuser ? "Zusagen: " + acceptedUsers : numberOfAcceptedUsers + " Zusagen");
                }
                html += "<hr/>";
                if (cancelledUsers == "") {
                    html += "Keine Absagen!";
                } else {
                    html += (_superuser ? "Absagen: " + cancelledUsers : numberOfCancelledUsers + " Absagen");
                }
            } else {
                if (_superuser) {
                    html += "<hr/>";
                    if (cancelledUsers == "") {
                        html += "Keine Absagen!";
                    } else {
                        html += "Absagen: " + cancelledUsers;
                    }
                }
                if ((!suppressCancellation) || _superuser) {
                    var workMap = getAcceptedUsersInMyVoice(appointment);
                    var workList = Object.keys(workMap).sort();
                    html += "<hr/>";
                    html += "Anwesenheit:<br/>";
                    html += "<table style='font-size:small;width:100%'>";
                    html += "<tr style='color:grey'><td></td><td>Werk</td><td>#</td><td>Grp</td></tr>";
                    for (var w=0; w<workList.length; w++) {
                        var work = workList[w];
                        var voiceMap = workMap[work];
                        for (var voice in voiceMap) {
                            var singersList = voiceMap[voice];
                            html += "<tr>";
                            html += "<td>&#8226;&nbsp;</td>";
                            html += "<td style='padding:1px;padding-left:5px'>" + work + "</td>";
                            html += "<td style='padding:1px;padding-left:5px'>" + singersList.length + "</td>";
                            html += "<td style='padding:1px;padding-left:5px'>" + voice + "</td>";
                            html += "</tr>";
                        }
                    }
                    html += "</table>";
                }
            }

            if (aptMsg != "") {
                html += "<hr/>";
                html += "<div class=\"info\" style=\"color:blue\">" + aptMsg + "</div>";
            }
            html += "<hr/>";
            if (suppressCancellation) {
                html += "<div>Absagen nur in Direktabsprache mit der Chorleitung</div>";
            } else {
                var cancelled = isCancelled(appointment);
                var accepted = isAccepted(appointment);
                console.log("cancelled " + cancelled);
                console.log("accepted " + accepted);
                if (appointment.attributes.allowAcceptance=="true") {
                    console.log("three choices");
                    // THREE CHOICES
                    if (!accepted) {
                        html += "<button type='button' class='btn btn-success' style='width:50%' onclick='javascript:setCancellation("+appointment.id+",true)\'>Termin zusagen</button>";
                    }
                    if (!cancelled) {
                        html += "<button type='button' class='btn btn-danger' style='width:50%' onclick='javascript:setCancellation("+appointment.id+",false)\'>Termin absagen</button>";
                    }
                    if (cancelled || accepted) {
                        html += "<button type='button' class='btn btn-outline-dark' style='width:50%' onclick='javascript:revokeCancellation("+appointment.id+")\'>Aktion widerrufen</button>";
                    }
                } else {
                    // TWO CHOICES
                    if (cancelled) {
                        html += "<button type='button' class='btn btn-success' style='width:100%' onclick='javascript:revokeCancellation("+appointment.id+")\'>Termin nicht absagen</button>";
                    } else {
                        html += "<button type='button' class='btn btn-danger' style='width:100%' onclick='javascript:setCancellation("+appointment.id+",false)\'>Termin absagen</button>";
                    }
                }
            }

            html += " </div>";
            html += " <div class='modal-footer'>";
            html += "  <button id='okBtn' type='button' class='btn btn-dark' onclick='javascript:hideDialog()\'>Zurück</button>";
            html += " </div>";
            html += "</div>";

            document.getElementById("dialog").innerHTML=html;
            document.getElementById("dialog").style.display='block';
        }

        function showInfo(header, message) {
            var html = "<div class='modal-content' style='border:3px solid #888'>";
            html += " <div class='modal-header'>";
            html += "  <h4 class='modal-title' align='center' style='width:100%;'>" + header + "</h4>";
		    html += " </div>";
		    html += " <div class='modal-body '>";
		    html += "  " + message;
		    html += " </div>";
            html += " <div class='modal-footer'>";
            html += "  <button id='okBtn' type='button' class='btn btn-dark' onclick='javascript:hideDialog()\'>Zurück</button>";
            html += " </div>";
            html += "</div>";

            document.getElementById("dialog").innerHTML=html;
            document.getElementById("dialog").style.display='block';
        }

        function hideDialog() {
            document.getElementById("dialog").style.display='none';
        }

        function isCancelled(appointment) {
            var cancelled = false;
            for (var i=0; i<appointment.children.length; i++) {
                var cancellation = appointment.children[i];
                if (cancellation && cancellation.attributes.userid == _userId) {
                    if (!cancellation.attributes.acception || cancellation.attributes.acception == "" || cancellation.attributes.acception == "false") {
                        cancelled = true;
                    }
                }
            }
            return cancelled;
        }

        function isAccepted(appointment) {
            var accepted = false;
            for (var i=0; i<appointment.children.length; i++) {
                var cancellation = appointment.children[i];
                if (cancellation && cancellation.attributes.userid == _userId) {
                    if (cancellation.attributes.acception == "true") {
                        accepted = true;
                    }
                }
            }
            return accepted;
        }

        function getActiveUserCancellation(appointment) {
            var activeUserCancellation = "";
            for (var i=0; i<appointment.children.length; i++) {
                var cancellation = appointment.children[i];
                if (cancellation && cancellation.attributes.userid == _userId) {
                    activeUserCancellation = cancellation;
                }
            }
            return activeUserCancellation;
        }

        function getCancelledUsers(appointment) {
            var cancelledUsers = "";
            var sep = "";
            for (var i=0; i<appointment.children.length; i++) {
                var cancellation = appointment.children[i];
                var name = _userMap[cancellation.attributes["userid"]];
                var cancelled = (!cancellation.attributes.acception || cancellation.attributes.acception == "" || cancellation.attributes.acception == "false");
                if (cancelled) {
                    if (!name || name=="") { name = cancellation.attributes["userid"]; }
                    cancelledUsers += sep+name;
                    sep = ", ";
                }
            }
            return cancelledUsers;
        }

        function getAcceptedUsers(appointment) {
            var acceptedUsers = "";
            var sep = "";
            for (var i=0; i<appointment.children.length; i++) {
                var cancellation = appointment.children[i];
                var name = _userMap[cancellation.attributes["userid"]];
                var accepted = (cancellation.attributes.acception == "true");
                if (accepted) {
                    if (!name || name=="") { name = cancellation.attributes["userid"]; }
                    acceptedUsers += sep+name;
                    sep = ", ";
                }
            }
            return acceptedUsers;
        }

        function getAcceptedUsersPerVoice(appointment) {
            var workMap = {};
            var cancellationList = [];
            for (var i=0; i<appointment.children.length; i++) {
                cancellationList.push(appointment.children[i].attributes["userid"]);
            }
            var workList = lookupElement(_data,"Work");
            var prj = lookupElement(_data,"Project");
            for (var i=0; i<workList.length; i++) {
                var work = workList[i];
                if (work.attributes["project"] === prj[0].attributes["id"]) {
                    var voiceMap = {};
                    for (var v=0; v<work.children.length; v++) {
                        var voice = work.children[v];
                        var singersList = voice.attributes["singerList"];
                        voiceMap[voice.attributes["shortid"]] = [];
                        for (var s=0; s<singersList.length; s++) {
                            if (!cancellationList.includes(singersList[s])) {
                                var name = _userMap[singersList[s]];
                                if (!name || name=="") { name = singersList[s]; }
                                voiceMap[voice.attributes["shortid"]].push(name);
                            }
                        }
                    }
                    workMap[work.attributes["id"]] = voiceMap;
                }
            }
            return workMap;
        }

        function getAcceptedUsersInMyVoice(appointment) {
            var workMap = {};
            var cancellationList = [];
            for (var i=0; i<appointment.children.length; i++) {
                cancellationList.push(appointment.children[i].attributes["userid"]);
            }
            var workList = lookupElement(_data,"Work");
            var prj = lookupElement(_data,"Project");
            for (var i=0; i<workList.length; i++) {
                var work = workList[i];
                if (work.attributes["project"] === prj[0].attributes["id"]) {
                    var voiceMap = {};
                    for (var v=0; v<work.children.length; v++) {
                        var voice = work.children[v];
                        var singersList = voice.attributes["singerList"];
                        if (singersList.includes(_userId)) {
                            voiceMap[voice.attributes["shortid"]] = [];
                            for (var s=0; s<singersList.length; s++) {
                                if (!cancellationList.includes(singersList[s])) {
                                    var name = _userMap[singersList[s]];
                                    if (!name || name=="") { name = singersList[s]; }
                                    voiceMap[voice.attributes["shortid"]].push(name);
                                }
                            }
                        }
                    }
                    workMap[work.attributes["id"]] = voiceMap;
                }
            }
            return workMap;
        }

        function getMyCancellations() {
            var count = 0;
            var list = lookupElement(_data, "Appointment");
            for (var i=0; i<list.length; i++) {
                var appointment = list[i];
                for (var j=0; j<appointment.children.length; j++) {
                     if (appointment.children[j].type==="Cancellation") {
                        var cancellation = appointment.children[j];
                        if (cancellation.attributes["userid"]===_userId) {
                            if (!cancellation.attributes.acception || cancellation.attributes.acception == "" || cancellation.attributes.acception == "false") {
                                count++;
                            }
                        }
                    }
                }
            }
            return count;
        }

        function setCancellation(id, acception) {
            console.log("[setCancellation("+id+","+acception+")]");
            var appointment = getElement(_data, id);
            var cancellation;
            for (var i=0; i<appointment.children.length; i++) {
                var can = appointment.children[i];
                if (can && can.attributes.userid == _userId) {
                    cancellation = can;
                }
            }
            console.log("cancellation: ");
            console.log(cancellation);
            if (cancellation) {
                // existing cancellation
                cancellation.attributes.acception = ""+acception;
            } else {
                // new cancellation
                var attributes = {};
                attributes["userid"] = _userId;
                attributes["acception"] = ""+acception;
                var newElement = { id: _next_id, parentId: appointment.id, type: "Cancellation", order: 0, attributes: attributes, children: [] }
                appointment.children.push(newElement);
                newElement.parentId = appointment.id;
            }
            ws.send("{\"command\":\"save\", \"data\":" + JSON.stringify(_data) + ", \"selectedId\":" + appointment.id + "}");
            hideDialog();
        }

        function revokeCancellation(id) {
            var appointment = getElement(_data, id);
            var cancellation = getActiveUserCancellation(appointment);
            if (cancellation != "") {
                // ws.send("{\"command\":\"deleteElement\", \"id\":" + cancellationid + "}");
                appointment.children.splice( appointment.children.indexOf(cancellation), 1 );
			    cancellation.parentId = cancellation.id;
			    ws.send("{\"command\":\"save\", \"data\":" + JSON.stringify(_data) + ", \"selectedId\":" + appointment.id + "}");
                hideDialog();
            }
        }

        function showTimeline() {
                upcomingAppointment = "";
                var html = "";
                var cancelledUsers = "";
                var list = lookupElement(_data, "Appointment");
                for (var i=0; i<list.length; i++) {
                    var appointment = list[i];
                    var aptId = appointment.id;
                    var suppressCancellation = getSuppressCancellation(appointment);
                    var dt = appointment.attributes["date"];
                    var dateYear = dt.substring(0,4);
                    var dateMonth = dt.substring(5,7);
                    var dateDay = dt.substring(8,10);
                    var datestr = dateYear + "-" + dateMonth + "-" + dateDay;
                    var datestrvis = dateDay + "." + dateMonth + "." + dateYear;
                    var dateShift = "";
                    var dateShiftShort = "";
                    if (/[: ,]+/.test(dt)) {
                        dateShift = " " + dt.split(/[: ,]+/)[1];
                        dateShiftShort = " (" + dateShift.charAt(1) + ")";
                    }
                    var d = new Date(datestr);
                    var weekday = dayName(d);
                    var timestamp = new Date().getTime();
                    var today = new Date(timestamp - (timestamp % 86400000));
                    var outdated = false;
                    if (d >= today && upcomingAppointment == "") {
                        upcomingAppointment = appointment;
                    } else if (d < today) {
                        outdated = true;
                    }
                    if (!outdated) {
                        var cancelled = isCancelled(appointment);
                        var accepted = isAccepted(appointment);
                        var cancelledUsers = getCancelledUsers(appointment);
                        var acceptedUsers = getAcceptedUsers(appointment);
                        var numberOfCancelledUsers = cancelledUsers==="" ? 0 : cancelledUsers.split(",").length;
                        var numberOfAcceptedUsers = acceptedUsers==="" ? 0 : acceptedUsers.split(",").length;
                        var appointmentType = appointment.attributes["type"];
                        var locId = appointment.attributes["location"];
                        var loc = getElementByTypeAndId(_data, "Location", locId);
                        var locName = loc.attributes["name"];
                        var locAddr = loc.attributes["address"];
                        var locPLZ = loc.attributes["plz"];
                        var locCity = loc.attributes["city"];
                        var btnClass = appointmentType==="GENERAL" ? "btn btn-warning" :
                                       appointmentType==="KONZERT" ? "btn btn-success" :
                                       appointmentType==="PWE" ? "btn btn-info" :
                                       appointmentType==="FEIER" ? "btn btn-secondary" :
                                       "btn btn-primary";
                        if (appointment==upcomingAppointment) {
                            var leitung = (_superuser ? " (Leitung)" : "");
                            var msg = "<h2 style='margin:0px'>Probenplaner</h2>";
                            msg += "<div style='font-style:italic;font-size:13px;width:100%;text-align:right;padding-right:8px'>";
                            msg += "<a href=\"javascript:showInfo('Neu in Version 1.2.1','<ul><li>&#x2022; Neue Farbcodes</li><li>&#x2022; Anzeige der Adresse des Probenorts</li><li>&#x2022; Button zum Herunterladen des Probenmaterials</li><li>&#x2022; Termine am Vormittag, Nachmittag, Abend</li></ul>')\">Version 1.2.1</a></div>";
                            msg += "<div class=\"p-1\">";
                            msg += "<button type='button' class='btn btn-dark' style=\"width:100%\" onclick='javascipt:location.replace(\"calendar.html?login="+_login+"\")'>Zur Listenansicht</button>";
                            msg += "</div>";
                            msg += "<h6 style='padding-top:8px;padding-bottom:8px;text-align:center;width:100%'>" + _userName + leitung + "</h6>";
                            msg += "Nächster Termin:<br/>";
                            msg += "<table>";
                            msg += "<tr><td>Datum&nbsp;&nbsp;</td><td>" + datestrvis + dateShift + "</td></tr>";
                            msg += "<tr><td>Uhrzeit&nbsp;&nbsp;</td><td>" + appointment.attributes["time"] + "</td></tr>";
                            msg += "<tr><td>Ort </td><td>" + locName + "</td></tr>";
                            msg += "<tr><td></td><td>" + locAddr + "<br/>" + locPLZ + " " + locCity + "</td></tr>";
                            msg += "</table>";
                            if (_superuser) {
                                msg += "<hr/>";
                                if (cancelledUsers == "") {
                                    msg += "Keine Absagen!";
                                } else {
                                    msg += "Absagen: " + cancelledUsers;
                                }
                                if (appointment.attributes.allowAcceptance == "true") {
                                    msg += "<hr/>";
                                    if (acceptedUsers == "") {
                                        msg += "Keine Zusagen!";
                                    } else {
                                        msg += "Zusagen: " + acceptedUsers;
                                    }
                                }
                            }
                            msg += "<hr/>";
                            var aptMsg = appointment.attributes["message"];
                            if (aptMsg != "") {
                                msg += "<dev style='color:blue'>" + aptMsg + "</div>";
                                msg += "<hr/>";
                            }
                            var myCancellations = getMyCancellations();
                            if (myCancellations > 0) {
                                msg += "<dev style='color:red'>Ich habe " + (myCancellations>1 ? myCancellations + " Proben":"eine Probe") + " abgesagt</div>";
                                msg += "<hr/>";
                            }
                            document.getElementById("message").innerHTML=msg;
                        }
                        html += "<div class=\"p-1\">";
                        html += "<button type=\"button\" " + (outdated?"disabled":"") + " class=\"" + btnClass + "\" style=\"width:100%\" onclick=\"javascript:showDialog("+aptId+",'" + datestrvis + dateShift + "')\">";
                        html += "<div>" + weekday + ". " + datestrvis + dateShiftShort;
                        if (appointment.attributes.allowAcceptance=="true") {
                            // three choices
                            if (cancelled) {
                                html += "<span style='float:right;color:red;border-radius:5px;background:#d0e0ff;width:2em;padding:2px 6px 2px 6px'>&#10008;</span>&nbsp;";
                            } else if (accepted) {
                                html += "<span style='float:right;color:green;border-radius:5px;background:#d0e0ff;width:2em;padding:2px 6px 2px 6px'>&#10004;</span>&nbsp;";
                            } else {
                                html += "<span style='float:right;color:gray;border-radius:5px;background:#d0e0ff;width:2em;padding:2px 6px 2px 6px'>?</span>&nbsp;";
                            }
                        } else {
                            // two choices
                            if (cancelled) {
                                html += "<span style='float:right;color:red;border-radius:5px;background:#d0e0ff;width:2em;padding:2px 6px 2px 6px'>&#10008;</span>&nbsp;";
                            } else {
                                html += "<span style='float:right;color:green;border-radius:5px;background:#d0e0ff;width:2em;padding:2px 6px 2px 6px'>&#10004;</span>&nbsp;";
                            }
                        }
                        html += "</div>";
                        html += "<div style='font-size:small'>" + _items[appointment.attributes["type"]];
                        html += " " + appointment.attributes["time"];
                        if (numberOfCancelledUsers>0) {
                            if ((!suppressCancellation) || _superuser) {
                                html += " (" + (numberOfCancelledUsers==1 ? "eine Absage" : numberOfCancelledUsers + " Absagen") + ")";
                            }
                        }
                        if (numberOfAcceptedUsers>0) {
                            if ((!suppressCancellation) || _superuser) {
                                html += " (" + (numberOfAcceptedUsers==1 ? "eine Zusage" : numberOfAcceptedUsers + " Zusagen") + ")";
                            }
                        }
                        html += "</div>";
                        html += "</button><br/>";
                        html += "</div>";
                    }
                }
                html += "<br/>";
                document.getElementById("timeline").innerHTML=html;
        }

        function getSuppressCancellation(appointment) {
            var result = false;
            var sc = appointment.attributes["suppressCancellation"];
            if (sc && sc==="true") {
                result = true;
            }
            return result;
        }

        function handleMessage(ws, data) {
            jo = JSON.parse(data);
            var command = jo["command"];
            var editPermission = jo["editPermission"];

            if (command==="setData") {
                _data = jo["data"];
                var directorArray = _data.attributes["director"];
                for (var i=0; i<directorArray.length; i++) { directorArray[i]=directorArray[i].trim();}
                _orig = JSON.parse(JSON.stringify(_data));
                addParents(_data, _data["id"]);
                _superuser = (directorArray.includes(_userId));
                showTimeline();
                hideDialog();
                document.getElementById("downloadSection").style.display='inline';
            } else if (command==="info") {
                var header = jo["header"];
                var message = jo["message"];
                showInfo(header, message);
            } else if (command==="setModel") {
                _model = jo["data"];
                _appName = jo["appName"];
                _userMap = jo["userMap"];
                _items = _model["Appointment"]["attributes"]["type"]["items"];
            } else if (command==="setUserId") {
                _userId = jo["userId"];
                _userName = _userMap[_userId];
                var maintenance = jo["maintenance"];
                console.log("maintenance: " + maintenance);
                if (maintenance.length>0) {
                    console.log("Closing session due to maintenance: " + maintenance);
                    showInfo("Wartungsarbeiten", "Bitte später erneut versuchen!");
                    ws.close();
                }
            } else if (command==="setDocumentList") {
                var documentReferenceMap = jo["data"];
                for (var name in documentReferenceMap) {
                    var id = documentReferenceMap[name];
                    documentMap[id] = name;
                }
            }
        }

        function addParents(data, parentId) {
            data.parentId = parentId;
            var children = data["children"];
            for (var i=0; i<children.length; i++) {
                addParents(children[i],data.id);
            }
        }



        // this is important to assure correct output from JSON.stringify!
	    delete Array.prototype.toJSON

		// document.observe("dom:loaded", function() {
		$( document ).ready(function() {
		    if (!window.WebSocket) {
	    	    alert("FATAL: WebSocket not natively supported. This demo will not work!");
	    	}
 			initWS();

		});
		window.onbeforeunload = function (evt) {
			sessionStorage.setItem("data", JSON.stringify(_data));
//			sessionStorage.setItem("clipboard", JSON.stringify(_clipboard));
			sessionStorage.setItem("orig", JSON.stringify(_orig));
			sessionStorage.setItem("model", JSON.stringify(_model));
        }
    </script>
    <title>Probenplaner</title>
</head>
<body>

<div style="margin-left:auto;margin-right:auto;width:300px">
    <br/>
    <div id="message"></div>
    <!-- div id="content" style="padding:10px">huhu</div -->
    <div id="timeline"></div>
    <div id="downloadSection" style="margin:3px;display:none">
        <button id='downloadButton' type='button' class='btn btn-dark' style="width:100%">Probenmaterial herunterladen</button>
    </div>
    </br>
    </br>
</div>
<iframe id="downloadFrame" style="display:none;"></iframe>
<script>
    document.getElementById("downloadButton").addEventListener("click", function() {
        const iframe = document.getElementById("downloadFrame");
        iframe.src = "download?login=" + _login;
    });
</script>
<style>
    #dialog {
      position: fixed;
      top: 50%;      /* move to the middle */
      left: 50%;
      transform: translate(-50%, -50%); /* center it exactly */
      background: white;   /* modal background */
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
      width: 400px;
      max-width: 90%;
      z-index: 1000;
    }
</style>

<div id="dialog" style="display:inline;"><div style="text-align:center;border:2px solid lightblue"><br/>Probenplaner<br/><br/></div></div>
</div>
</body>
</html>
