<!DOCTYPE html>
<html lang="de">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="icon" href="/rehearsal/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" type="text/css" href="sport/css/style.css">
    <link rel="stylesheet" type="text/css" href="sport/css/bootstrap.min.css">
    <meta name="robots" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <script type="text/javascript" src="sport/lib/jquery-3.5.1.slim.min.js"></script>
    <script type="text/javascript" src="sport/lib/popper.min.js"></script>
    <script type="text/javascript" src="sport/lib/bootstrap.min.js"></script>
    <script type="text/javascript" src="sport/js/datamodel.js"></script>
    <script type="text/javascript">

        var rootName = "Schubert";
        var rootId = 1;

        const params = new URLSearchParams(window.location.search);
        const _login = params.get("login");
        const dayName = (date) => date.toLocaleDateString("de-DE", { weekday: "long" }).slice(0, 2);

        var upcomingAppointment = "";
        var _userName = "";
        var _userId = "";
        var _userMap = {};
        var _next_id = -1;
        var _superuser = false;
        var reload = (sessionStorage.getItem("data")==null || sessionStorage.getItem("data")=="null" ? false : true);
        var _actionMap = {};
        var _orig = (reload ? JSON.parse(sessionStorage.getItem("orig")) : null );
        var _data = null;//(reload ? JSON.parse(sessionStorage.getItem("data")) : null );
        var _model = (reload ? JSON.parse(sessionStorage.getItem("model")) : null );
        var _items = {};
	    var _appName = "-";
	    var documentMap = {};

        var ws;
        function initWS() {
            console.log("Running project: " + getProjectId());
            // var wsUri = "ws://" + window.location.hostname + ":" + window.location.port + "/" + getProjectId() + "/socket";
            const wsUri = (window.location.protocol === "https:" ? "wss://" : "ws://") + window.location.hostname + ":" + window.location.port + "/" + getProjectId() + "/socket" + "?login="+_login;

            console.log("connecting to: " + wsUri);
            ws = new WebSocket(wsUri);
            ws.onopen = function() {
                console.log("[WebSocket#onopen]\n");
            }
            ws.onmessage = function(e) {
                jo = JSON.parse(e.data);
                handleMessage(ws, e.data);
            }
            ws.onclose = function() {
                console.log("[WebSocket#onclose]\n");
                ws = null;
                document.getElementById("message").innerHTML="Tschöö!";
                document.getElementById("timeline").innerHTML="";
                setTimeout(function() {
                    document.getElementById("dialog").innerHTML="";
                    document.getElementById("dialog").style.display='none';
                 }, 3000);
            }
            if (ws) {
                setTimeout(function() {
                    for (var id in documentMap) {
                        var name = documentMap[id];
                        if (name==rootName) {
                            rootId = id;
                        }
                    }
                    ws.send("{\"command\":\"openDocument\", \"id\":"+rootId+"}");
                }, 500);
                // $("header").innerHTML="<br/>Speedy";
            }
        }

        function requestElement(parentId, id) {
            if (ws) {
                ws.send("{\"command\":\"requestElement\", \"parentId\":"+parentId+", \"id\":"+id+"}");
            }
        }

        function getProjectId() {
            return window.location.pathname.split("/")[1];
        }

        function showDialog(id, datestrvis) {
            var appointment = getElement(_data, id);
            var aptMsg = appointment.attributes["message"];
            var suppressCancellation = getSuppressCancellation(appointment);
            var aptType = appointment.attributes["type"];
            var typeLabel = _items[aptType];
            var color = "";
            var html = "<div class='modal-content'>";
		    if (appointment.id == upcomingAppointment.id) {
		        color="orange";
		    } else {
		        color="black";
		    }
		    html += " <div class='modal-header'>";
		    html += "  <h4 class='modal-title' align='center' style='width:100%;color:" + color + "'>" + datestrvis + "</h4>";
		    html += " </div>";
		    html += " <div class='modal-body '>";
            html += " <div class=\"info\">" + typeLabel + "</div>";

            html += "<table>";
            html += "<tr><td>Datum&nbsp;&nbsp;</td><td>" + datestrvis + "</td></tr>";
            html += "<tr><td>Uhrzeit&nbsp;&nbsp;</td><td>" + appointment.attributes["time"] + "</td></tr>";
            html += "<tr><td>Ort </td><td>" + appointment.attributes["location"] + "</td></tr>";
            html += "</table>";
            var cancelledUsers = getCancelledUsers(appointment);
            if (_superuser) {
                html += "<hr/>";
                if (cancelledUsers == "") {
                    html += "Keine Absagen!";
                } else {
                    html += "Absagen: " + cancelledUsers;
                }
           }
           {
                var workMap = getAcceptedUsersInMyVoice(appointment);
                var workList = Object.keys(workMap).sort();
                if ((!suppressCancellation) || _superuser) {
                    html += "<hr/>";
                    html += "Anwesenheit:<br/>";
                    html += "<table style='font-size:small;width:100%'>";
                    html += "<tr style='color:grey'><td></td><td>Werk</td><td>#</td><td>Grp</td></tr>";
                    for (var w=0; w<workList.length; w++) {
                        var work = workList[w];
                        var voiceMap = workMap[work];
                        for (var voice in voiceMap) {
                            var singersList = voiceMap[voice];
                            html += "<tr>";
                            html += "<td>&#8226;&nbsp;</td>";
                            html += "<td style='padding:1px;padding-left:5px'>" + work + "</td>";
                            html += "<td style='padding:1px;padding-left:5px'>" + singersList.length + "</td>";
                            html += "<td style='padding:1px;padding-left:5px'>" + voice + "</td>";
                            html += "</tr>";
                        }
                    }
                    html += "</table>";
                }
           }


            if (aptMsg != "") {
                html += "<hr/>";
                html += "<div class=\"info\" style=\"color:blue\">" + aptMsg + "</div>";
            }
            html += "<hr/>";
            if (suppressCancellation) {
                html += "<div>Absagen nur in Direktabsprache mit der Chorleitung</div>";
            } else {
                var cancelled = isCancelled(appointment);
                if (cancelled) {
                    html += "<button type='button' class='btn btn-success' style='width:100%' onclick='javascript:revokeCancellation("+appointment.id+")\'>Termin nicht absagen</button>";
                } else {
                    html += "<button type='button' class='btn btn-danger' style='width:100%' onclick='javascript:cancelAppointment("+appointment.id+")\'>Termin absagen</button>";
                }
            }

            html += " </div>";
            html += " <div class='modal-footer'>";
            html += "  <button id='okBtn' type='button' class='btn btn-dark' onclick='javascript:hideDialog()\'>Zurück</button>";
            html += " </div>";
            html += "</div>";

            document.getElementById("dialog").innerHTML=html;
            document.getElementById("dialog").style.display='block';
        }

        function showInfo(header, message) {
            var html = "<div class='modal-content'>";
            html += " <div class='modal-header'>";
            html += "  <h4 class='modal-title' align='center' style='width:100%;'>" + header + "</h4>";
		    html += " </div>";
		    html += " <div class='modal-body '>";
		    html += "  " + message;
		    html += " </div>";
            html += " <div class='modal-footer'>";
            html += "  <button id='okBtn' type='button' class='btn btn-dark' onclick='javascript:hideDialog()\'>Zurück</button>";
            html += " </div>";
            html += "</div>";

            document.getElementById("dialog").innerHTML=html;
            document.getElementById("dialog").style.display='block';
        }

        function hideDialog() {
            document.getElementById("dialog").style.display='none';
        }

        function isCancelled(appointment) {
            var cancelled = false;
            for (var i=0; i<appointment.children.length; i++) {
                var cancellation = appointment.children[i];
                if (cancellation && cancellation.attributes.userid == _userId) {
                    cancelled = true;
                }
            }
            return cancelled;
        }

        function getActiveUserCancellation(appointment) {
            var activeUserCancellation = "";
            for (var i=0; i<appointment.children.length; i++) {
                var cancellation = appointment.children[i];
                if (cancellation && cancellation.attributes.userid == _userId) {
                    activeUserCancellation = cancellation;
                }
            }
            return activeUserCancellation;
        }

        function getCancelledUsers(appointment) {
            var cancelledUsers = "";
            var sep = "";
            for (var i=0; i<appointment.children.length; i++) {
                var cancellation = appointment.children[i];
                var name = _userMap[cancellation.attributes["userid"]];
                if (!name || name=="") { name = cancellation.attributes["userid"]; }
                cancelledUsers += sep+name;
                sep = ", ";
            }
            return cancelledUsers;
        }

        function getAcceptedUsersPerVoice(appointment) {
            var workMap = {};
            var cancellationList = [];
            for (var i=0; i<appointment.children.length; i++) {
                cancellationList.push(appointment.children[i].attributes["userid"]);
            }
            var workList = lookupElement(_data,"Work");
            for (var i=0; i<workList.length; i++) {
                var work = workList[i];
                var voiceMap = {};
                for (var v=0; v<work.children.length; v++) {
                    var voice = work.children[v];
                    var singersList = voice.attributes["singers"].split(",");
                    voiceMap[voice.attributes["shortid"]] = [];
                    for (var s=0; s<singersList.length; s++) {
                        if (!cancellationList.includes(singersList[s])) {
                            var name = _userMap[singersList[s]];
                            if (!name || name=="") { name = singersList[s]; }
                            voiceMap[voice.attributes["shortid"]].push(name);
                        }
                    }
                }
                workMap[work.attributes["id"]] = voiceMap;
            }
            return workMap;
        }

        function getAcceptedUsersInMyVoice(appointment) {
            var workMap = {};
            var cancellationList = [];
            for (var i=0; i<appointment.children.length; i++) {
                cancellationList.push(appointment.children[i].attributes["userid"]);
            }
            var workList = lookupElement(_data,"Work");
            for (var i=0; i<workList.length; i++) {
                var work = workList[i];
                var voiceMap = {};
                for (var v=0; v<work.children.length; v++) {
                    var voice = work.children[v];
                    var singersList = voice.attributes["singers"].split(",");
                    if (singersList.includes(_userId)) {
                        voiceMap[voice.attributes["shortid"]] = [];
                        for (var s=0; s<singersList.length; s++) {
                            if (!cancellationList.includes(singersList[s])) {
                                var name = _userMap[singersList[s]];
                                if (!name || name=="") { name = singersList[s]; }
                                voiceMap[voice.attributes["shortid"]].push(name);
                            }
                        }
                    }
                }
                workMap[work.attributes["id"]] = voiceMap;
            }
            return workMap;
        }

        function getMyCancellations() {
            var count = 0;
            var list = lookupElement(_data, "Appointment");
            for (var i=0; i<list.length; i++) {
                var appointment = list[i];
                for (var j=0; j<appointment.children.length; j++) {
                    if (appointment.children[j].type==="Cancellation" && appointment.children[j].attributes["userid"]===_userId) {
                        count++;
                    }
                }
            }
            return count;
        }

        function cancelAppointment(id) {
            var appointment = getElement(_data, id);
            var attributes = {};
            attributes["userid"] = _userId;
            var newElement = { id: _next_id, parentId: appointment.id, type: "Cancellation", order: 0, attributes: attributes, children: [] }
            appointment.children.push(newElement);
			newElement.parentId = appointment.id;

            ws.send("{\"command\":\"save\", \"data\":" + JSON.stringify(_data) + ", \"selectedId\":" + appointment.id + "}");
            hideDialog();
        }

        function revokeCancellation(id) {
            var appointment = getElement(_data, id);
            var cancellation = getActiveUserCancellation(appointment);
            if (cancellation != "") {
                // ws.send("{\"command\":\"deleteElement\", \"id\":" + cancellationid + "}");
                appointment.children.splice( appointment.children.indexOf(cancellation), 1 );
			    cancellation.parentId = cancellation.id;
			    ws.send("{\"command\":\"save\", \"data\":" + JSON.stringify(_data) + ", \"selectedId\":" + appointment.id + "}");
                hideDialog();
            }
        }

        function showTimeline() {
                upcomingAppointment = "";
                var html = "";
                var cancelledUsers = "";
                var list = lookupElement(_data, "Appointment");
                for (var i=0; i<list.length; i++) {
                    var appointment = list[i];
                    var aptId = appointment.id;
                    var suppressCancellation = getSuppressCancellation(appointment);
                    var dt = appointment.attributes["date"];
                    var dateYear = dt.substring(0,4);
                    var dateMonth = dt.substring(5,7);
                    var dateDay = dt.substring(8,10);
                    var datestr = dateYear + "-" + dateMonth + "-" + dateDay;
                    var datestrvis = dateDay + "." + dateMonth + "." + dateYear;

                    var d = new Date(datestr);
                    var weekday = dayName(d);
                    var timestamp = new Date().getTime();
                    var today = new Date(timestamp - (timestamp % 86400000));
                    var outdated = false;
                    if (d >= today && upcomingAppointment == "") {
                        upcomingAppointment = appointment;
                    } else if (d < today) {
                        outdated = true;
                    }
                    if (!outdated) {
                        var cancelled = isCancelled(appointment);
                        var cancelledUsers = getCancelledUsers(appointment);
                        var numberOfCancelledUsers = cancelledUsers==="" ? 0 : cancelledUsers.split(",").length;
                        var btnClass = "btn btn-primary";
                        if (appointment==upcomingAppointment) {
                            btnClass = "btn btn-warning";
                            var leitung = (_superuser ? " (Leitung)" : "");
                            var msg = "<h2>Probenplaner</h2>";
                            msg += "<div class=\"p-1\">";
                            msg += "<button type='button' class='btn btn-dark' style=\"width:100%\" onclick='javascipt:location.replace(\"calendar.html?login="+_login+"\")'>Zur Listenansicht</button>";
                            msg += "</div>";
                            msg += "<h6 style='padding-top:8px;padding-bottom:8px;text-align:center;width:100%'>" + _userName + leitung + "</h6>";
                            msg += "Nächster Termin:<br/>";
                            msg += "<table>";
                            msg += "<tr><td>Datum&nbsp;&nbsp;</td><td>" + datestrvis + "</td></tr>";
                            msg += "<tr><td>Uhrzeit&nbsp;&nbsp;</td><td>" + appointment.attributes["time"] + "</td></tr>";
                            msg += "<tr><td>Ort </td><td>" + appointment.attributes["location"] + "</td></tr>";
                            msg += "</table>";
                            if (_superuser) {
                                msg += "<hr/>";
                                if (cancelledUsers == "") {
                                    msg += "Keine Absagen!";
                                } else {
                                    msg += "Absagen: " + cancelledUsers;
                                }
                            }
                            msg += "<hr/>";
                            var aptMsg = appointment.attributes["message"];
                            if (aptMsg != "") {
                                msg += "<dev style='color:blue'>" + aptMsg + "</div>";
                                msg += "<hr/>";
                            }
                            var myCancellations = getMyCancellations();
                            if (myCancellations > 0) {
                                msg += "<dev style='color:red'>Ich habe " + (myCancellations>1 ? myCancellations + " Proben":"eine Probe") + " abgesagt</div>";
                                msg += "<hr/>";
                            }
                            document.getElementById("message").innerHTML=msg;
                        }
                        html += "<div class=\"p-1\">";
                        html += "<button type=\"button\" " + (outdated?"disabled":"") + " class=\"" + btnClass + "\" style=\"width:100%\" onclick=\"javascript:showDialog("+aptId+",'" + datestrvis+ "')\">";
                        html += "<div>" + weekday + ". " + datestrvis;
                        if (cancelled) {
                            html += "<span style='float:right;color:red;border-radius:5px;background:#d0e0ff;padding:2px 6px 2px 6px'>&#10008;</span>&nbsp;";
                        } else {
                            html += "<span style='float:right;color:green;border-radius:5px;background:#d0e0ff;padding:2px 6px 2px 6px'>&#10004;</span>&nbsp;";
                        }
                        html += "</div>";
                        html += "<div style='font-size:small'>" + _items[appointment.attributes["type"]];
                        html += " " + appointment.attributes["time"];
                        if (numberOfCancelledUsers>0) {
                            if ((!suppressCancellation) || _superuser) {
                                html += " (" + (numberOfCancelledUsers==1 ? "eine Absage" : numberOfCancelledUsers + " Absagen") + ")";
                            }
                        }
                        html += "</div>";
                        html += "</button><br/>";
                        html += "</div>";
                    }
                }
                html += "<br/>";
                document.getElementById("timeline").innerHTML=html;
        }

        function getSuppressCancellation(appointment) {
            var result = false;
            var sc = appointment.attributes["suppressCancellation"];
            if (sc && sc==="true") {
                result = true;
            }
            return result;
        }

        function handleMessage(ws, data) {
            jo = JSON.parse(data);
            var command = jo["command"];
            var editPermission = jo["editPermission"];

            if (command==="setData") {
                _data = jo["data"];
                var directorArray = _data.attributes["director"].split(",");
                for (var i=0; i<directorArray.length; i++) { directorArray[i]=directorArray[i].trim();}
                _orig = JSON.parse(JSON.stringify(_data));
                addParents(_data, _data["id"]);
                _superuser = (directorArray.includes(_userId));
                showTimeline();
                hideDialog();
            } else if (command==="info") {
                var header = jo["header"];
                var message = jo["message"];
                showInfo(header, message);
            } else if (command==="setModel") {
                _model = jo["data"];
                _appName = jo["appName"];
                _userMap = jo["userMap"];
                _items = _model["Appointment"]["attributes"]["type"]["items"];
            } else if (command==="setUserId") {
                _userId = jo["userId"];
                _userName = _userMap[_userId];
                var maintenance = jo["maintenance"];
                console.log("maintenance: " + maintenance);
                console.log("maintehance.length>0" + (maintenance.length>0));
                if (maintenance.length>0) {
                    console.log("Closing session due to maintenance: " + maintenance);
                    showInfo("Wartungsarbeiten", "Bitte später erneut versuchen!");
                    ws.close();
                }
            } else if (command==="setDocumentList") {
                var documentReferenceMap = jo["data"];
                for (var name in documentReferenceMap) {
                    var id = documentReferenceMap[name];
                    documentMap[id] = name;
                }
            }
        }

        function addParents(data, parentId) {
            data.parentId = parentId;
            var children = data["children"];
            for (var i=0; i<children.length; i++) {
                addParents(children[i],data.id);
            }
        }



        // this is important to assure correct output from JSON.stringify!
	    delete Array.prototype.toJSON

		// document.observe("dom:loaded", function() {
		$( document ).ready(function() {
		    if (!window.WebSocket) {
	    	    alert("FATAL: WebSocket not natively supported. This demo will not work!");
	    	}
 			initWS();

		});
		window.onbeforeunload = function (evt) {
			sessionStorage.setItem("data", JSON.stringify(_data));
//			sessionStorage.setItem("clipboard", JSON.stringify(_clipboard));
			sessionStorage.setItem("orig", JSON.stringify(_orig));
			sessionStorage.setItem("model", JSON.stringify(_model));
        }
    </script>
    <title>Probenplaner</title>
</head>
<body>

<div style="margin-left:auto;margin-right:auto;width:300px">
    <br/>
    <div id="message"></div>
    <!-- div id="content" style="padding:10px">huhu</div -->
    <div id="timeline"></div>
</div>
<style>
    #dialog {
      position: fixed;
      top: 50%;      /* move to the middle */
      left: 50%;
      transform: translate(-50%, -50%); /* center it exactly */
      background: white;   /* modal background */
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
      width: 400px;
      max-width: 90%;
      z-index: 1000;
    }
</style>

<div id="dialog" style="display:none"></div>
</div>
</body>
</html>